generator client {
  provider   = "prisma-client-js"
  engineType = "library" // force node-api engine; avoids client/accelerate requirement when not using Neon adapter
}

datasource db {
  provider = "postgresql"
}

model Product {
  id            String                 @id @default(cuid())
  name          String
  slug          String                 @unique
  type          ProductType            @default(COFFEE)
  weightInGrams Int                    @default(0)
  description   String?
  tastingNotes  String[]
  isOrganic     Boolean                @default(false)
  isFeatured    Boolean                @default(false)
  featuredOrder Int?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  origin        String[]
  roastLevel    RoastLevel             @default(MEDIUM)
  altitude      String?
  variety       String?
  categories    CategoriesOnProducts[]
  images        ProductImage[]
  tags          ProductTag[]
  variants      ProductVariant[]
  addOns        ProductAddOn[]         @relation("PrimaryProductAddOn")
  addOnFor      ProductAddOn[]         @relation("AddOnProduct")

  @@index([isFeatured])
}

model CategoriesOnProducts {
  productId  String
  categoryId String
  isPrimary  Boolean  @default(false)
  category   Category @relation(fields: [categoryId], references: [id])
  product    Product  @relation(fields: [productId], references: [id])

  @@id([productId, categoryId])
}

model Category {
  id                  String                 @id @default(cuid())
  name                String
  slug                String                 @unique
  isUsingDefaultLabel Boolean                @default(true)
  labelSettingId      String
  order               Int                    @default(0)
  showPurchaseOptions Boolean                @default(true)
  products            CategoriesOnProducts[]
  labelSetting        SiteSettings           @relation("CategoryLabel", fields: [labelSettingId], references: [id])

  @@index([labelSettingId])
}

model ProductImage {
  id        String  @id @default(cuid())
  url       String
  altText   String
  order     Int     @default(0)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model ProductVariant {
  id              String           @id @default(cuid())
  name            String
  weightInGrams   Int?
  productId       String
  stockQuantity   Int              @default(0)
  product         Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  purchaseOptions PurchaseOption[]
  addOnLinks      ProductAddOn[]   @relation("AddOnVariant")

  @@index([productId])
}

model PurchaseOption {
  id                   String           @id @default(cuid())
  type                 PurchaseType     @default(ONE_TIME)
  priceInCents         Int
  variantId            String
  billingInterval      BillingInterval?
  billingIntervalCount Int?
  orderItems           OrderItem[]
  variant              ProductVariant   @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([variantId])
}

model ProductAddOn {
  id                     String          @id @default(cuid())
  productId              String
  addOnProductId         String
  addOnVariantId         String?
  discountedPriceInCents Int?
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  product                Product         @relation("PrimaryProductAddOn", fields: [productId], references: [id], onDelete: Cascade)
  addOnProduct           Product         @relation("AddOnProduct", fields: [addOnProductId], references: [id], onDelete: Restrict)
  addOnVariant           ProductVariant? @relation("AddOnVariant", fields: [addOnVariantId], references: [id], onDelete: Restrict)

  @@unique([productId, addOnProductId, addOnVariantId])
  @@index([productId])
  @@index([addOnProductId])
  @@index([addOnVariantId])
}

model SiteSettings {
  id                String     @id @default(cuid())
  key               String     @unique
  value             String
  updatedAt         DateTime   @updatedAt
  categoriesAsLabel Category[] @relation("CategoryLabel")
}

model User {
  id            String         @id @default(cuid())
  name          String?
  email         String?        @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  isAdmin       Boolean        @default(false)
  accounts      Account[]
  addresses     Address[]
  orders        Order[]
  sessions      Session[]
  subscriptions Subscription[]
  activities    UserActivity[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Address {
  id         String  @id @default(cuid())
  street     String
  city       String
  state      String
  postalCode String
  country    String
  isDefault  Boolean @default(false)
  userId     String
  user       User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Order {
  id                    String         @id @default(cuid())
  totalInCents          Int
  status                OrderStatus    @default(PENDING)
  deliveryMethod        DeliveryMethod @default(DELIVERY)
  userId                String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  customerEmail         String?
  stripeCustomerId      String?
  stripePaymentIntentId String?
  stripeSessionId       String?
  paymentCardLast4      String?
  recipientName         String?
  shippingCity          String?
  shippingCountry       String?
  shippingPostalCode    String?
  shippingState         String?
  shippingStreet        String?
  carrier               String?
  shippedAt             DateTime?
  trackingNumber        String?
  stripeSubscriptionId  String?        @unique
  user                  User?          @relation(fields: [userId], references: [id], onDelete: Restrict)
  items                 OrderItem[]

  @@index([userId])
  @@index([stripeSessionId])
  @@index([stripeSubscriptionId])
  @@index([customerEmail])
}

model OrderItem {
  id               String         @id @default(cuid())
  quantity         Int
  priceInCents     Int
  orderId          String
  purchaseOptionId String
  order            Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  purchaseOption   PurchaseOption @relation(fields: [purchaseOptionId], references: [id])

  @@index([orderId])
  @@index([purchaseOptionId])
}

model Subscription {
  id                   String             @id @default(cuid())
  stripeSubscriptionId String             @unique
  stripeCustomerId     String
  status               SubscriptionStatus @default(ACTIVE)
  priceInCents         Int
  deliverySchedule     String?
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?
  recipientName        String?
  shippingStreet       String?
  shippingCity         String?
  shippingState        String?
  shippingPostalCode   String?
  shippingCountry      String?
  userId               String
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  productDescription   String?
  productNames         String[]
  quantities           Int[]
  stripePriceIds       String[]
  stripeProductIds     String[]
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeSubscriptionId])
  @@index([stripeCustomerId])
}

model UserActivity {
  id           String       @id @default(cuid())
  sessionId    String
  userId       String?
  activityType ActivityType
  productId    String?
  productSlug  String?
  categorySlug String?
  searchQuery  String?
  source       String?
  metadata     Json?
  createdAt    DateTime     @default(now())
  user         User?        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@index([productId])
  @@index([activityType, createdAt])
}

model SocialLink {
  id            String   @id @default(cuid())
  platform      String   @unique
  url           String
  icon          String
  order         Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  customIconUrl String?
  useCustomIcon Boolean  @default(false)

  @@index([order])
  @@index([isActive])
}

model Tag {
  id        String       @id @default(cuid())
  name      String       @unique
  label     String
  color     TagColor
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  products  ProductTag[]

  @@index([name])
}

model ProductTag {
  id           String   @id @default(cuid())
  productId    String
  tagId        String
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag          Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([productId, tagId])
  @@index([productId])
  @@index([tagId])
}

model NewsletterSubscriber {
  id               String   @id @default(cuid())
  email            String   @unique
  subscribedAt     DateTime @default(now())
  isActive         Boolean  @default(true)
  unsubscribeToken String   @unique @default(cuid())

  @@index([email])
  @@index([isActive])
  @@index([unsubscribeToken])
}

model Page {
  id               String    @id @default(cuid())
  slug             String    @unique
  title            String
  heroImage        String?
  content          String
  parentId         String?
  showInFooter     Boolean   @default(false)
  footerOrder      Int?
  metaDescription  String?
  isPublished      Boolean   @default(false)
  publishedAt      DateTime?
  generatedBy      String?
  generationPrompt Json?
  generatedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  type             PageType  @default(GENERIC)
  icon             String?
  headerOrder      Int?
  showInHeader     Boolean   @default(false)
  url              String?
  blocks           Block[]
  parent           Page?     @relation("PageHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children         Page[]    @relation("PageHierarchy")

  @@index([slug])
  @@index([type])
  @@index([parentId])
  @@index([isPublished])
}

model Block {
  id              String   @id @default(cuid())
  type            String
  order           Int
  content         Json
  isDeleted       Boolean  @default(false)
  originalContent Json?
  pageId          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  layoutColumn    String   @default("full")
  page            Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@index([order])
}

model AiTokenUsage {
  id               String   @id @default(cuid())
  modelId          String
  provider         String? // e.g., gemini, openai, anthropic
  feature          String? // logical feature name, e.g., about-assist
  route            String? // API route used
  pageId           String? // optional page linkage
  actorType        String? // admin, customer, system
  status           String? // success or error code
  promptTokens     Int?
  completionTokens Int?
  latencyMs        Int?
  tokens           Int? // per-request total (optional)
  createdAt        DateTime @default(now())

  @@index([createdAt])
  @@index([modelId, provider, createdAt])
  @@index([feature, createdAt])
  @@index([provider, modelId, createdAt])
}

enum PurchaseType {
  ONE_TIME
  SUBSCRIPTION
}

enum BillingInterval {
  DAY
  WEEK
  MONTH
  YEAR
}

enum ActivityType {
  PAGE_VIEW
  PRODUCT_VIEW
  SEARCH
  ADD_TO_CART
  REMOVE_FROM_CART
}

enum ProductType {
  COFFEE
  MERCH
}

enum OrderStatus {
  PENDING
  SHIPPED
  PICKED_UP
  CANCELLED
  FAILED
}

enum DeliveryMethod {
  DELIVERY
  PICKUP
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELED
  PAST_DUE
}

enum RoastLevel {
  LIGHT
  MEDIUM
  DARK
}

enum TagColor {
  RED
  ORANGE
  GREEN
  BLUE
  PURPLE
  YELLOW
  GRAY
}

enum PageType {
  GENERIC
  ABOUT
  CAFE
  FAQ
  LINK
}
