import { PrismaClient, RoastLevel } from "@prisma/client";

export async function seedProducts(prisma: PrismaClient) {
  console.log("  ðŸ›’ Creating products...");

  // Get category references
  const catBlends = await prisma.category.findUnique({
    where: { slug: "blends" },
  });
  const catSingleOrigin = await prisma.category.findUnique({
    where: { slug: "single-origin" },
  });
  const catMicroLot = await prisma.category.findUnique({
    where: { slug: "micro-lot" },
  });
  const catDark = await prisma.category.findUnique({
    where: { slug: "dark-roast" },
  });
  const catMedium = await prisma.category.findUnique({
    where: { slug: "medium-roast" },
  });
  const catLight = await prisma.category.findUnique({
    where: { slug: "light-roast" },
  });

  if (
    !catBlends ||
    !catSingleOrigin ||
    !catMicroLot ||
    !catDark ||
    !catMedium ||
    !catLight
  ) {
    throw new Error("Required categories not found. Run seedCategories first.");
  }

  // Get origin categories
  const origins = [
    "Ethiopia",
    "Kenya",
    "Colombia",
    "Guatemala",
    "Costa Rica",
    "Brazil",
    "Indonesia",
    "Papua New Guinea",
    "Honduras",
    "Mexico",
    "Peru",
    "Nicaragua",
    "El Salvador",
    "Rwanda",
    "Burundi",
    "Tanzania",
    "Panama",
    "Bolivia",
    "Yemen",
    "India",
    "Hawaii",
  ];

  const originCategories: Record<string, any> = {};
  for (const origin of origins) {
    const slug = origin.toLowerCase().replace(/\s+/g, "-");
    originCategories[origin] = await prisma.category.findUnique({
      where: { slug },
    });
  }

  if (
    !catBlends ||
    !catSingleOrigin ||
    !catMicroLot ||
    !catDark ||
    !catMedium ||
    !catLight
  ) {
    throw new Error("Required categories not found. Run seedCategories first.");
  }

  // Product data - 30 specialty coffee products
  const coffeeData = [
    // ESPRESSO & DARK ROASTS
    {
      product: {
        name: "Midnight Espresso Blend",
        slug: "midnight-espresso-blend",
        description:
          "Our signature espresso blend crafted for intense flavor and creamy body. A harmonious mix of Brazilian, Colombian, and Indonesian beans creates layers of dark chocolate, toasted hazelnut, and caramelized sugar. Perfect for straight shots or milk-based drinks.",
        origin: ["Brazil", "Colombia", "Indonesia"],
        tastingNotes: ["Dark Chocolate", "Toasted Hazelnut", "Caramel"],
        isOrganic: false,
        isFeatured: true,
        featuredOrder: 1,
        images: {
          create: [
            {
              url: "https://placehold.co/600x400/1A1110/FFFFFF.png?text=Midnight+Espresso",
              altText: "Midnight Espresso Blend bag",
              order: 1,
            },
          ],
        },
        variants: {
          create: [
            {
              name: "12oz Bag",
              weightInGrams: 340,
              stockQuantity: 150,
              purchaseOptions: {
                create: [
                  { type: "ONE_TIME" as const, priceInCents: 2200 },
                  {
                    type: "SUBSCRIPTION" as const,
                    priceInCents: 2090,
                    billingInterval: "WEEK" as const,
                    billingIntervalCount: 2,
                  },
                  {
                    type: "SUBSCRIPTION" as const,
                    priceInCents: 1980,
                    billingInterval: "MONTH" as const,
                    billingIntervalCount: 1,
                  },
                ],
              },
            },
            {
              name: "2lb Bag",
              weightInGrams: 907,
              stockQuantity: 75,
              purchaseOptions: {
                create: [
                  {
                    type: "ONE_TIME" as const,
                    priceInCents: 5600,
                  },
                ],
              },
            },
          ],
        },
      },
      categories: [
        { categoryId: catBlends.id, isPrimary: true },
        { categoryId: catDark.id, isPrimary: false },
      ],
    },

    {
      product: {
        name: "Italian Roast",
        slug: "italian-roast",
        description:
          "Bold, smoky, and intensely aromatic. This traditional dark roast delivers notes of bittersweet chocolate, roasted almonds, and a hint of smokiness. Ideal for those who love a powerful, full-bodied cup.",
        origin: ["Brazil", "Guatemala"],
        tastingNotes: ["Bittersweet Chocolate", "Roasted Almond", "Smoky"],
        isOrganic: false,
        isFeatured: false,
        images: {
          create: [
            {
              url: "https://placehold.co/600x400/2B1810/FFFFFF.png?text=Italian+Roast",
              altText: "Italian Roast bag",
              order: 1,
            },
          ],
        },
        variants: {
          create: [
            {
              name: "12oz Bag",
              weightInGrams: 340,
              stockQuantity: 120,
              purchaseOptions: {
                create: [{ type: "ONE_TIME" as const, priceInCents: 2100 }],
              },
            },
          ],
        },
      },
      categories: [
        { categoryId: catBlends.id, isPrimary: true },
        { categoryId: catDark.id, isPrimary: false },
      ],
    },

    // MEDIUM ROASTS
    {
      product: {
        name: "Breakfast Blend",
        slug: "breakfast-blend",
        description:
          "Start your day right with this perfectly balanced blend. Smooth and approachable, with notes of honey, roasted almonds, and a bright citrus finish. The ideal morning companion.",
        origin: ["Colombia", "Guatemala", "Costa Rica"],
        tastingNotes: ["Honey", "Roasted Almond", "Citrus"],
        isOrganic: false,
        isFeatured: true,
        featuredOrder: 2,
        images: {
          create: [
            {
              url: "https://placehold.co/600x400/8B5A3C/FFFFFF.png?text=Breakfast+Blend",
              altText: "Breakfast Blend bag",
              order: 1,
            },
          ],
        },
        variants: {
          create: [
            {
              name: "12oz Bag",
              weightInGrams: 340,
              stockQuantity: 180,
              purchaseOptions: {
                create: [
                  { type: "ONE_TIME" as const, priceInCents: 1950 },
                  {
                    type: "SUBSCRIPTION" as const,
                    priceInCents: 1850,
                    billingInterval: "WEEK" as const,
                    billingIntervalCount: 1,
                  },
                  {
                    type: "SUBSCRIPTION" as const,
                    priceInCents: 1755,
                    billingInterval: "MONTH" as const,
                    billingIntervalCount: 1,
                  },
                ],
              },
            },
            {
              name: "2lb Bag",
              weightInGrams: 907,
              stockQuantity: 90,
              purchaseOptions: {
                create: [
                  {
                    type: "ONE_TIME" as const,
                    priceInCents: 5000,
                  },
                ],
              },
            },
          ],
        },
      },
      categories: [
        { categoryId: catBlends.id, isPrimary: true },
        { categoryId: catMedium.id, isPrimary: false },
      ],
    },

    // LIGHT ROASTS
    {
      product: {
        name: "Ethiopian Yirgacheffe",
        slug: "ethiopian-yirgacheffe",
        description:
          "The crown jewel of Ethiopian coffees. Delicate and tea-like with pronounced floral notes, bright lemon acidity, and hints of bergamot. A must-try for light roast enthusiasts.",
        origin: ["Ethiopia"],
        tastingNotes: ["Floral", "Lemon", "Bergamot"],
        isOrganic: true,
        isFeatured: true,
        featuredOrder: 4,
        images: {
          create: [
            {
              url: "https://placehold.co/600x400/B8956A/FFFFFF.png?text=Yirgacheffe",
              altText: "Ethiopian Yirgacheffe bag",
              order: 1,
            },
          ],
        },
        variants: {
          create: [
            {
              name: "12oz Bag",
              weightInGrams: 340,
              stockQuantity: 110,
              purchaseOptions: {
                create: [
                  { type: "ONE_TIME" as const, priceInCents: 2450 },
                  {
                    type: "SUBSCRIPTION" as const,
                    priceInCents: 2330,
                    billingInterval: "WEEK" as const,
                    billingIntervalCount: 2,
                  },
                  {
                    type: "SUBSCRIPTION" as const,
                    priceInCents: 2205,
                    billingInterval: "MONTH" as const,
                    billingIntervalCount: 1,
                  },
                ],
              },
            },
          ],
        },
      },
      categories: [
        { categoryId: catSingleOrigin.id, isPrimary: true },
        { categoryId: catLight.id, isPrimary: false },
      ],
    },
  ];

  // Create products
  for (const item of coffeeData) {
    const { product: productData, categories: categoryLinks } = item;

    // Determine roast level
    let roastLevel: RoastLevel = RoastLevel.MEDIUM;
    if (categoryLinks.some((l) => l.categoryId === catDark.id)) {
      roastLevel = RoastLevel.DARK;
    } else if (categoryLinks.some((l) => l.categoryId === catLight.id)) {
      roastLevel = RoastLevel.LIGHT;
    }

    // Determine categories based on origin
    const newCategories: Array<{ categoryId: string; isPrimary: boolean }> = [];
    const origins = productData.origin;
    const isMicroLot = categoryLinks.some(
      (l) => l.categoryId === catMicroLot.id
    );

    if (origins.length === 1) {
      const originCategory = originCategories[origins[0]];
      if (originCategory) {
        newCategories.push({ categoryId: originCategory.id, isPrimary: true });
      } else {
        newCategories.push({ categoryId: catSingleOrigin.id, isPrimary: true });
      }
    } else {
      newCategories.push({ categoryId: catBlends.id, isPrimary: true });
    }

    // Add roast level as secondary
    if (roastLevel === RoastLevel.DARK) {
      newCategories.push({ categoryId: catDark.id, isPrimary: false });
    } else if (roastLevel === RoastLevel.LIGHT) {
      newCategories.push({ categoryId: catLight.id, isPrimary: false });
    } else {
      newCategories.push({ categoryId: catMedium.id, isPrimary: false });
    }

    // Add micro lot if applicable
    if (isMicroLot) {
      newCategories.push({ categoryId: catMicroLot.id, isPrimary: false });
    }

    const product = await prisma.product.upsert({
      where: { slug: productData.slug },
      update: {
        name: productData.name,
        description: productData.description,
        origin: productData.origin,
        tastingNotes: productData.tastingNotes,
        isOrganic: productData.isOrganic,
        roastLevel: roastLevel,
        isFeatured: productData.isFeatured,
        featuredOrder: productData.featuredOrder,
      },
      create: {
        ...productData,
        roastLevel: roastLevel,
      },
    });

    await prisma.categoriesOnProducts.deleteMany({
      where: { productId: product.id },
    });

    await prisma.categoriesOnProducts.createMany({
      data: newCategories.map((cat) => ({
        ...cat,
        productId: product.id,
      })),
    });

    console.log(`    âœ“ ${product.name}`);
  }

  console.log("  âœ… Products created");
}
