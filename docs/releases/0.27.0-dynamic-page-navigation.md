# Release 0.27.0 - Dynamic Page Navigation

**Release Date:** 2025-11-29  
**Type:** Feature Enhancement  
**Branch:** `feat/block-based-page-system`

## Overview

Implemented database-driven navigation system that allows administrators to configure which pages appear in the site header and footer, with custom icons and display ordering. This provides flexible content management without code changes.

## Database Changes

### Migration: `20251129053008_add_show_in_header_to_pages`

Added navigation-related fields to the `Page` model:

```json

model Page {
  // ... existing fields
  showInHeader Boolean @default(false)
  headerOrder  Int?
  showInFooter Boolean @default(false)
  footerOrder  Int?
  icon         String? // Lucide icon name
}
```

**Impact:**

- Existing pages default to `showInHeader: false` and `showInFooter: false`
- No breaking changes to existing functionality
- Pages remain accessible via direct URL even if not in navigation

## New Components

### `DynamicIcon` Component

**Location:** `components/app-components/DynamicIcon.tsx`

**Purpose:** Render Lucide React icons dynamically by string name

**Features:**

- Accepts icon name as string prop
- Fallback to FileText icon if name not found
- Optional label with configurable positioning (right/bottom)
- Exports `COMMON_PAGE_ICONS` constant for UI selectors

**Usage:**

```tsx

<DynamicIcon name="Coffee" size={20} />
<DynamicIcon name="MapPin" label="Location" labelPosition="right" />
```

## Server Actions

### `getPagesForHeader()`

**Location:** `app/actions.ts`

**Returns:** Array of pages configured to appear in header

- Filters: `isPublished: true`, `showInHeader: true`
- Orders: By `headerOrder` (nulls last), then alphabetically by `title`
- Selects: `id`, `slug`, `title`, `icon`, `headerOrder`

### `getPagesForFooter()`

**Location:** `app/actions.ts`

**Returns:** Array of pages configured to appear in footer

- Filters: `isPublished: true`, `showInFooter: true`
- Orders: By `footerOrder` (nulls last), then alphabetically by `title`
- Selects: `id`, `slug`, `title`, `icon`, `footerOrder`

## Updated Components

### `SiteHeader`

**Changes:**

- Added `PageLink` interface and `pages` prop
- Desktop navigation: Renders dynamic pages after Coffee dropdown
- Mobile navigation: Includes dynamic pages in sheet menu
- Uses `DynamicIcon` for custom page icons
- Routes to `/pages/${page.slug}`

### `SiteFooter`

**Changes:**

- Fetches pages via `getPagesForFooter()`
- Renders dynamic pages in "Quick Links" section with icons
- Maintains existing Home link and FooterAccountLinks

### `PageEditor`

**Changes:**

- Added "Show Page Link in Site Header" checkbox with display order input
- Added "Show Page Link in Footer" checkbox with display order input
- Icon selector UI (prepared for future enhancement)
- Checkbox handlers convert `CheckedState` to boolean: `checked === true`
- Saves navigation fields via `onMetadataUpdate`

### Page Editor Clients

Updated all page-specific editor clients to include navigation props:

- `app/admin/pages/about/AboutEditorClient.tsx`
- `app/admin/pages/cafe/CafeEditorClient.tsx`
- `app/admin/pages/faq/FaqEditorClient.tsx`

**Standardized Props:**

```typescript

interface EditorClientProps {
  pageId: string;
  pageSlug: string;
  pageTitle: string;
  initialBlocks: Block[];
  isPublished: boolean;
  metaDescription: string | null;
  showInHeader: boolean;
  showInFooter: boolean;
  headerOrder: number | null;
  footerOrder: number | null;
  icon: string | null;
}
```

## API Changes

### `PATCH /api/pages/[id]`

**Updated:** Handles navigation metadata fields dynamically

**Supported Fields:**

- `showInHeader`: boolean
- `headerOrder`: number | null
- `showInFooter`: boolean
- `footerOrder`: number | null
- `icon`: string | null

**Next.js 15 Compatibility:**
Fixed async params pattern: `const { id } = await params;`

## Performance Optimization

### Static Generation

**Location:** `app/(site)/pages/[...slug]/page.tsx`

**Added:** `generateStaticParams()` function

**Benefits:**

- Pre-renders all published pages at build time
- Reduces server load for frequently accessed pages
- Improves Time to First Byte (TTFB)
- Better SEO with static HTML

**Implementation:**

```typescript

export async function generateStaticParams() {
  const pages = await prisma.page.findMany({
    where: { isPublished: true },
    select: { slug: true },
  });
  return pages.map((page) => ({
    slug: page.slug.split("/"),
  }));
}
```

## Additional Improvements

### Mobile UI Enhancement

**Component:** `lib/page-layouts/two-column.tsx`

**Change:** Implemented carousel for stats blocks on mobile devices

**Benefits:**

- Better mobile UX with horizontal scrolling
- Space-efficient display of multiple stats
- Native touch gestures with Shadcn Carousel

### Code Cleanup

**Deleted Files:**

- `components/BlockSlot.tsx` - Unused legacy code
- `components/PageEditor.tsx` - Duplicate/old version

**Removed Code:**

- Legacy `pendingBlock` dialog system from two-column layout
- Unused imports across multiple files

## Testing Performed

### Manual Testing

- ✅ Pages appear in header when `showInHeader` enabled
- ✅ Pages appear in footer when `showInFooter` enabled
- ✅ Display order works correctly (nulls appear last)
- ✅ Icons render correctly from string names
- ✅ Mobile navigation includes dynamic pages
- ✅ Carousel displays stats correctly on mobile
- ✅ Static generation pre-renders pages at build

### TypeScript Validation

- ✅ Fixed all TypeScript compilation errors
- ✅ Type-safe checkbox handlers with CheckedState
- ✅ Proper type annotations for Block unions
- ✅ Next.js 15 async params compatibility

## Admin Usage

1. Navigate to Admin → Pages
2. Edit any page (About, Cafe, FAQ, or custom pages)
3. In the settings panel, check "Show Page Link in Site Header"
4. Optionally set a display order number (lower numbers appear first)
5. Optionally enable "Show Page Link in Footer"
6. Save changes
7. Page will appear in navigation with selected icon

## Future Enhancements

- Icon picker UI with visual selection
- Drag-and-drop reordering in admin interface
- Sub-navigation / dropdown support
- Conditional visibility based on user role
- Navigation analytics

## Technical Notes

### TypeScript Challenges

**Issue:** Complex Block union types caused `setBlocks()` type incompatibility

**Solution:** Added type assertion `as Block[]` when setting blocks array

**Rationale:** TypeScript cannot guarantee that a sorted array of blocks maintains compatibility with all Block union type variants, even though runtime behavior is correct.

### Next.js 15 Migration

All async route params now follow the pattern:

```typescript

async function handler({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;
  // ...
}
```

### Prisma Ordering

Used advanced ordering to handle nullable `headerOrder`/`footerOrder`:

```json

orderBy: [{ headerOrder: { sort: "asc", nulls: "last" } }, { title: "asc" }];
```

This ensures pages with explicit order appear first, followed by pages without order (sorted alphabetically).

## Deployment Checklist

- [x] Database migration applied
- [x] Prisma client regenerated
- [x] TypeScript errors resolved
- [x] ESLint warnings acknowledged (pre-existing)
- [x] Documentation created
- [x] CHANGELOG.md updated
- [ ] Version bumped to 0.27.0
- [ ] Feature branch committed
- [ ] Merged to main
- [ ] Production deployment verified

## Rollback Plan

If issues arise:

1. Revert database migration:

   ```sql
   ALTER TABLE "Page" DROP COLUMN "showInHeader";
   ALTER TABLE "Page" DROP COLUMN "headerOrder";
   ALTER TABLE "Page" DROP COLUMN "showInFooter";
   ALTER TABLE "Page" DROP COLUMN "footerOrder";
   ALTER TABLE "Page" DROP COLUMN "icon";
```

2. Revert code changes via Git:

   ```bash
   git revert <commit-hash>
   ```

3. Pages will revert to static navigation (Home, Coffee, About, Cafe, FAQ, Contact)

## Related Documentation

- `docs/release-workflow.md` - Feature branch merge process
- `prisma/schema.prisma` - Current database schema
- `CHANGELOG.md` - User-facing release notes
