# Copilot Project Guidance

- **App/platform**: Next.js 16 App Router + TypeScript (strict), Tailwind/shadcn UI; root layout wires `SessionProvider`, `ThemeProvider`, Vercel Analytics, `EnvironmentIndicator` (`app/layout.tsx`). Paths alias to `@/*` and `@components/*` (see `tsconfig.json`).
- **Routing**: App Router route groups split customer pages (`app/(site)`) and admin features (`app/admin/...`). Shared layout sits at `app/layout.tsx`; sub-layouts live under those groups—follow the grouping when adding pages.
- **Data access**: `lib/prisma.ts` picks adapter based on `DATABASE_ADAPTER` (`neon|postgres|standard`) or `neon.tech` in the URL. It forces node-api engine, loads `.env.local` if needed, and uses Neon WebSockets only when necessary. Keep this detection intact when touching DB code.
- **Schema shape**: Core models in `prisma/schema.prisma`—products/variants/purchase options, orders/subscriptions, user activity tracking, CMS pages + blocks (`Page` has both `blocks` and legacy `content`), `AiTokenUsage` for LLM telemetry. `PageType` enum drives layout choices.
- **CMS model**: Production path is block-based pages; demo path can fall back to `Page.content` (see `docs/demo-pages-architecture.md`). If `blocks` are empty, render legacy HTML; shop-owner features should prefer blocks. Admin/site navigation pulls published pages via `app/actions.ts` with header/footer ordering.
- **AI recommendations**: Direct context injection into Gemini (no RAG) because catalog ~30 products; see `docs/ai-recommendations-architecture-internal.md` for rationale and data flow (behavioral signals + full catalog per request).
- **Seeds**: Modular seeding lives in `prisma/seed/*.ts`; orchestrated by `npm run seed`. Order: settings → categories → products → users → CMS pages → synthetic data. Seeds are idempotent (`upsert`) and honor `SEED_LOCATION_TYPE` (SINGLE vs MULTI café layouts). Prefer importing seed modules for targeted scripts.
- **DB safety & backups**: `npm run db:backup` writes JSON snapshots under `dev-tools/backups/`; `npm run db:restore` rehydrates in FK-safe order. `npm run check:backup-models` guards schema drift; `npm run build:safe` = backup coverage check + backup + build. Use `npm run db:safe-migrate` before risky migrations.
- **Local setup**: Copy `.env.example` → `.env.local`, run `npx prisma generate`, `npx prisma migrate deploy`, then `npm run seed`. Stripe webhooks require `stripe listen --forward-to localhost:3000/api/webhooks/stripe` (see `SETUP.md`).
- **Build/run**: `npm run dev` for development; `npm run build` runs `prisma generate` first. `start` serves production build. Postinstall triggers `prisma generate`.
- **Testing**: Jest via `npm test` (watch) or `npm run test:ci`; config in `jest.config.js` uses `next/jest`, jsdom env, aliases for `@/` and `@components/`, and skips API route tests for now. Type safety via `npm run typecheck`; lint via `npm run lint`.
- **Auth/payments**: Auth.js (GitHub/Google + credentials) backed by Prisma. Stripe checkout/webhooks drive order state; keep `STRIPE_WEBHOOK_SECRET` synced and run the CLI listener locally. Resend is wired for emails via env vars.
- **Linting standards**: ESLint is strict—no `any`, no `setState` in effects, no components created during render, exhaustive deps warning, `@next/next/no-html-link-for-pages` enforced. Unused vars are warnings (prefix `_` if intentional). Some dev AI wizard paths are globally ignored.
- **Images**: Next image config allows only `placehold.co`, `lh3.googleusercontent.com`, `avatars.githubusercontent.com`, `github.com`; add hosts in `next.config.ts` when introducing new media sources.
- **Testing/seed data**: `prisma/seed/README.md` describes module order, selective seeding patterns, and recovery after schema changes. Synthetic data seeds include user activities/orders/newsletter for analytics/recs demos.
- **Patterns**: Use server actions (`"use server"`) for DB-backed fetches like header/footer pages and cart variants. Keep Prisma singleton pattern to avoid connection exhaustion. Blocks/pages use `PageType` to determine layout; maintain header/footer ordering fields when adding navigation.

If anything here is unclear or missing for your task, tell me what to adjust and I’ll update this guidance.
